{% extends 'base.html' %}

{% block title %}Process Harmonization Percentage{% endblock %}

{% block content %}
<center>
 <h1>Process Harmonization Percentage per Country</h1>
 <h2>Welcome to my program created using Django!</h2>
</center>

<form method="get" action="{% url 'calculate_harmonization_per_country' %}">
    <label for="region">Select a Region:</label>
    <select name="region" id="region">
        <option value="">--Select Region--</option>
        {% for region in regions %}
        <option value="{{ region }}" {% if region == selected_region %}selected{% endif %}>{{ region }}</option>
        {% endfor %}
    </select>

    <label for="cluster">Select a Cluster:</label>
    <select name="cluster" id="cluster" {% if not selected_region %}disabled{% endif %}>
        <option value="">--Select Cluster--</option>
        {% for cluster in clusters %}
        <option value="{{ cluster }}" {% if cluster == selected_cluster %}selected{% endif %}>{{ cluster }}</option>
        {% endfor %}
    </select>

    <label for="country">Select a Country to Highlight:</label>
    <select name="country" id="country" {% if not selected_cluster %}disabled{% endif %}>
        <option value="">--Select Country--</option>
        {% for country in countries %}
        <option value="{{ country.country_description }}" {% if country.country_description == selected_country %}selected{% endif %}>
            {{ country.country_description }}
        </option>
        {% endfor %}
    </select>

    <button type="submit">Submit</button>
</form>
<center>
<img src="data:image/png;base64,{{ chart_base64 }}" alt="Harmonization Percentage per Country Chart" />
</center>

<h2>By Country</h2>
<table>
  <thead>
    <tr>
      <th>Country</th>
      <th>Region</th>
      <th>Cluster</th>
      <th>Harmonization Percentage</th>
    </tr>
  </thead>
  <tbody>
    {% for data in calculate_harmonization_data %}
    <tr>
      <td>{{ data.country }}</td>
      <td>{{ data.region }}</td>
      <td>{{ data.cluster }}</td>
      <td>{{ data.calculate_harmonization_percentage }}%</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const regions = JSON.parse('{{ regions|escapejs }}');
        const clusters = JSON.parse('{{ clusters|escapejs }}');
        const countries = JSON.parse('{{ countries|escapejs }}');

        const regionSelect = document.getElementById('region');
        const clusterSelect = document.getElementById('cluster');
        const countrySelect = document.getElementById('country');

        regionSelect.addEventListener('change', function() {
            const selectedRegion = this.value;
            filterClusters(selectedRegion);
            filterCountries(selectedRegion, clusterSelect.value);
        });

        clusterSelect.addEventListener('change', function() {
            const selectedCluster = this.value;
            filterCountries(regionSelect.value, selectedCluster);
        });

        function filterClusters(region) {
            clusterSelect.innerHTML = '<option value="">--Select Cluster--</option>';
            const filteredClusters = clusters.filter(cluster => cluster.region === region);
            const uniqueClusters = [...new Set(filteredClusters.map(cluster => cluster.cluster))];
            uniqueClusters.forEach(clusterName => {
                const option = document.createElement('option');
                option.value = clusterName;
                option.textContent = clusterName;
                clusterSelect.appendChild(option);
            });
            clusterSelect.disabled = !uniqueClusters.length;
        }

        function filterCountries(region, cluster) {
            countrySelect.innerHTML = '<option value="">--Select Country--</option>';
            const filteredCountries = countries.filter(country =>
                (!region || country.region === region) &&
                (!cluster || country.cluster === cluster)
            );
            filteredCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.country_description;
                option.textContent = country.country_description;
                countrySelect.appendChild(option);
            });
            countrySelect.disabled = !filteredCountries.length;
        }
    });
</script>

{% endblock %}
